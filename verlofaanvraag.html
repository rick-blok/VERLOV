<!DOCTYPE html>
<html>
<head>
<script type="text/javascript">
<!--
var params = "";
var p = [];
p['begin_datum']="";
p['begin_tijd']="";
p['eind_datum']="";
p['eind_tijd']="";
p['aantal_uur']="";
p['toelichting']="";
p['person_id']=0;
p['empno']=0;
p['verlof_type']="V";
p['parafeerder']=0;
p['user_id']=0;
p['nids']=0;
p['to_url']=0;
p['locatie']=0;
p['saldo_verlof']=0;
p['saldo_atv']=0;
p['stnd_uren']=0;
p['pagina']=0;

//Verlofcodes. eerste letter voor dag(delen) (- indien nvt), tweede letter voor uren
var types = {
		'Verlof' : "VX", 
		'ATV' : "AY",
		'Buitengewoon' : "-B", //toelichting nodig
		'Calamiteiten' : "-K", //toelichting nodig
		'Artsbezoek'   : "-D", //toelichting nodig
		'Compensatie'  : "-C"
	};

var aanvragenverstuurd=0;
var verloven = [];

var weeksBeforeNow = 0;
var weeksAfterNow = 0;

// Get user specific variables
var http = new XMLHttpRequest();
var urlget = "http://verlof/";
http.open('GET', urlget, true);
http.onreadystatechange = function() {//Call a function when the state changes.
    if(http.readyState == 4 && http.status == 200) {
        document.getElementById('response').innerHTML = http.responseText;
		
		// get variables for post
		p['pagina'] 	= document.querySelector("#response input[name='pagina']").value;
		p['person_id'] 	= document.querySelector("#response input[name='person_id']").value;
		p['empno'] 		= document.querySelector("#response input[name='empno']").value;
		p['parafeerder']= document.getElementById("parafeerder").value;
		p['user_id']	= document.querySelector("#response input[name='user_id']").value;
		p['nids']		= document.querySelector("#response input[name='nids']").value;
		p['to_url']		= document.querySelector("#response input[name='to_url']").value;
		p['locatie']	= document.querySelector("#response input[name='locatie']").value;
		p['saldo_verlof']=document.querySelector("#response input[name='saldo_verlof']").value;
		p['saldo_atv']	= document.querySelector("#response input[name='saldo_atv']").value;
		p['stnd_uren']	= document.querySelector("#response input[name='stnd_uren']").value;
		
		aanvragenverstuurd++;
		maakAanvraag();
		
	} else {
		alert("er ging iets mis?");
	}
}
http.send();
aanvragenverstuurd=0; // eerste keer laden is voor variablen. 

function maakAanvraag(){
	
}


function stuurAanvraag(){
	var url = 'http://verlof/v1.1/VerlofSubmit.php';
	params = "";
	for (var key in p){
		params +=  key + "=" + p[key] + "&" ;
	}
	params = params.substring(0, params.length - 1);
	http.open('POST', url, true);
	http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
	http.send(params);
}


function checkInputCalendar(){
	verloven = [];

	for (var type in types){
		var e = document.getElementById(type).getElementsByTagName('input');
		for (var i = 0; i < e.length; i++){ 
			// sanitize
			if (!e[i].value.match(/^\d?(\.\d)?$/)){
				if (e[i].value != "" )
					e[i].classList.add("error"); 
				continue;	
			} else if (e[i].value == "" )
				continue
			e[i].classList.remove("error");
			
			var j = verloven.length;
			verloven[j] = [];
			if (types[type][0] != "-" && Number(e[i].value) % 4 == 0){
				//dag
				if ( (j > 0 && verloven[j-1]["type"][0] == types[type][0] && verloven[j-1]["eindt"] == "17:12" ) ){
					// ga verder met de vorige
					verloven[j-1]["eind"] = e[i].name;
					verloven[j-1]["eindt"] = Number(e[i].value) == 4 ? "12:30" : "17:12";
					verloven[j-1]["aantal"] += Number(e[i].value);
					verloven.pop();
				} else {
					// nieuwe aanvraag
					verloven[j]["start"] = e[i].name;
					verloven[j]["startt"] = Number(e[i].value) == 4 ? "13:12" : "8:30";
					verloven[j]["eind"] = e[i].name;
					verloven[j]["eindt"] = "17:12";
					verloven[j]["type"] = types[type][0] + " " + type + " dag";
					verloven[j]["aantal"] = Number(e[i].value);
				}
			} else{
				//uren
				verloven[j]["start"] = e[i].name;
				verloven[j]["eind"] = e[i].name;
				verloven[j]["type"] = types[type][1] + " " + type + " uur";
				verloven[j]["aantal"] = Number(e[i].value);
				
				if ( types[type][1] == "K" || types[type][1] == "B" || types[type][1] == "D"|| types[type][1] == "L" || types[type][1] == "O" ) {
					do {
						verloven[j]["reden"] = prompt("Reden voor " + type + " op " + e[i].name);
					} while (verloven[j]["reden"] == "" || verloven[j]["reden"] == " ");
				}
			}
		}
	}
	console.debug(verloven);
}

function createVerlofLijst(){
	var e =  document.getElementById("labels");
	
	var div = document.createElement("div");
	var txt = document.createTextNode( "-" );
	div.classList.add("label");
	div.appendChild(txt);
	e.appendChild(div);
	for (var type in types){
		var div = document.createElement("div");
		var txt = document.createTextNode( type );
		div.classList.add("label");
		div.appendChild(txt);
		e.appendChild(div);
	}
	
	
	var e =  document.getElementById("wrapper");

	var div = document.createElement("div");
	div.setAttribute("id", "header");
	e.appendChild(div);
	for (var type in types){
		var div = document.createElement("div");
		div.setAttribute("id", type);
		e.appendChild(div);
	}
}

function addWeekBefore(){
	var d = new Date()
	d.setDate(d.getDate() - ++weeksBeforeNow*7);
	
	addWeek(d, "before");
}

function addWeekAfter(){
	var d = new Date()
	d.setDate(d.getDate() + ++weeksAfterNow*7);
	
	addWeek(d, "after");
}

function addWeek( withDate = new Date(), pos="after"){
	//monday of specified week
	var startDate = new Date(withDate.getFullYear(), withDate.getMonth(), withDate.getDate() - ((withDate.getUTCDay() + 6) % 7)); 
	//monday of this week
	var d = new Date();
	var thisMonday = new Date(d.getFullYear(), d.getMonth(), d.getDate() - ((d.getUTCDay() + 6) % 7))
	var thisWeek = ( startDate.getTime() == thisMonday.getTime());
	
	// add dates to header
	var e = document.getElementById("header");
	var div = document.createElement("div");
	div.classList.add("week"); 
	if (thisWeek)
		div.classList.add("current");
	for (var i = 0; i < 7; i++){
		var date = new Date();
		date.setDate(startDate.getDate() + i);
		var span  = document.createElement("span");
		var txt = document.createTextNode( date.getDate() + "-" + date.getMonth() );
		span.appendChild(txt);
		div.appendChild(span);
	}
	if(pos == "after")
		e.appendChild(div);
	else
		e.prepend(div);
	
	//add inputboxes
	for (var type in types){
		var e = document.getElementById(type);
		var div = document.createElement("div");
		div.classList.add("week"); 
		if (thisWeek)
			div.classList.add("current");
		
		for (var i = 0; i < 5; i++){
			var date = new Date();
			date.setDate(startDate.getDate() + i);
			var input = document.createElement("input");
			input.setAttribute("type", "text");
			input.setAttribute("name", date.getDate() + "-" + date.getMonth() + "-" + date.getFullYear() );
			div.appendChild(input);
		}
		if(pos == "after")
			e.appendChild(div);
		else
			e.prepend(div);
	}
	
	
	/*
	var node = document.createElement("LI");                 // Create a <li> node
	var textnode = document.createTextNode("Water");         // Create a text node
	node.appendChild(textnode);                              // Append the text to <li>
	document.getElementById("myList").appendChild(node);     // Append <li> to <ul> with id="myList"
	*/
}

function getWeekNumber(d) {
    // Copy date so don't modify original
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    // Set to nearest Thursday: current date + 4 - current day number
    // Make Sunday's day number 7
    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
    // Get first day of year
    var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    // Calculate full weeks to nearest Thursday
    var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
    // Return array of year and week number
    return [d.getUTCFullYear(), weekNo];
}

window.onload = function (){
	createVerlofLijst();
	addWeek();
	addWeekBefore();
	addWeekAfter();
}

//-->
</script>
<style type="text/css">
<!--
#input{
	height: 15em;
	background-color: #DDD;
	top:0;
	left:0;
	right:0;
	position:absolute;
}
#response{
   overflow-x:auto;
   top:15em;  /* as the height of the other div is 30px */
   left:0;
   right:0;
   bottom:0;
   position:absolute;
}
#calendar{
	display: table-row;
}
#left {
	float:left;
	display: table-cell;
	width: 2em;
	display: inline-block;
}
#right{
	float: right;
	width: 2em;
	display: inline-block;
}
#wrapper {
	display: inline-block;
	overflow-x: scroll;
	width: 1000px;
	white-space: nowrap;
}
#wrapper div{
	height: 1.5em;
}

#header .week span{
	width: 2.9em;
	display: inline-block;
	text-align: center;
	font-size: small;
	padding: 0;
	margin: 0;
	border: 1px solid;
	height: 1.5em;
}
.week{
	width: 18em;
	display: inline-block;
	background-color:#FFF;
	height: 1.5em;
}
.week:nth-child(2n){
	background-color:#DDD;
}
.week input{
	width:2.85em;
	padding: 0;
	margin: 0;
	border: 1px solid;
	height: 1.5em;
}

.current{
	background-color: #DDF;
}
.error{
	background-color: #FCC;
}
#labels{
	display: inline-block;
	width: 8em;
	vertical-align: top
}
.label{
	width: 4em;
	height: 1.5em;
}
//-->
</style>
<body>
<div id="input">
	<div id="calendar">
		<div id="left">
			<a href="#" onclick="javascript:addWeekBefore()">-</a>
		</div>
		<div id="labels"></div>
		<div id="wrapper"></div>
		<div id="right">
			<a href="#" onclick="javascript:addWeekAfter()">+</a>
		</div>
	</div>
	<a href="#" onclick="javascript:checkInputCalendar();">Check Input</a><br>
	<a href="#" onclick="javascript:stuurAanvraag();">doe aanvraag</a>
</div>
<div id="response"></div>

</body>
</html>
